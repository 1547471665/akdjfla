{"compress":true,"commitItems":[["9cd4b646-844e-4077-a7e4-9103896c1b5d",1521773291161,"",[[1521773264278,["wangnan@wangnandeMacBook-Pro.local",[[1,0,"03. MySQL主从搭建(基于GTID)\n===\n\n\n\n\n## 1. 配置主服务器\n```\nserver-id = 1\ngtid_mode = ON  # 开启GTID模式\nenforce-gtid-consistency = ON  # 开启后保证在使用GTID模式时的一致性，而且开启GTID后必须开启此模式，否则服务启动会报错\nlog-slave-updates = 1   # Slave将从master接收到的更新执行完毕后执行binlog记录到slave中自己的binlog\nskip-slave-start = 1   # 当Slave服务启动时，不自动开启复制\nlog_bin = mysql-bin   # 开启binlog日志，必须开启\nbinlog_format = row   # 建议binlog为Row的格式，其他格式可能会造成不一致\nexpire_logs_days = 99   # binlog保存 99天(最大99)\n```\n## 2. 配置从服务器\n```\nserver-id = 2\ngtid_mode = ON\nenforce-gtid-consistency = ON\nlog-slave-updates = 1\nskip-slave-start = 1\nlog_bin = mysql-bin\nbinlog_format = row\nexpire_logs_days = 99\n```\n## 3. 主服务器复制账号授权\n```\nGRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'repl_slave'@'10.20.95.7' identified by 'p&j0h^8H4c50^7L67zd9\\vLm2(5a6*<x';\n```\n## 4. 搭建主从\n### A. 如果Master是新搭建，且无数据:\n直接设置从服务器:\n```\nCHANGE MASTER TO MASTER_HOST='mysql-master-1', MASTER_PORT=3306, MASTER_USER='repl_slave', MASTER_PASSWORD='p&j0h^8H4c50^7L67zd9\\vLm2(5a6*<x', MASTER_AUTO_POSITION=1;\n\n查看复制状态：\nshow slave status\\G\nSlave_IO_Running: No\nSlave_SQL_Running: No\n\n开启复制\nstart slave;(因为配置了skip-slave-start = 1,所以默认不自动开启复制)\n查看复制状态：\nshow slave status\\G\nSlave_IO_Running: Yes\nSlave_SQL_Running: Yes\n\n查看进程\nshow processlist;\n```\n### B. Master运行不久，所有BinLog保存完整:\n可同A方式\n优点: 简单方便\n缺点: 如果BinLog相对较多, 则Slave同步时间较长，可能导致网络压力过大。\n\n### C. Master运行时间较久，存在大量数据，BinLog已不完整(无法从开头获取所有的GTID信息进行恢复):\n思路：\n\t从Master上获取所有的备份数据，并获得这些备份数据的GTID范围，然后设置Slave的gtid_purged来跳过这些GTID，再将从Master的备份数据恢复到Slave，最后再通过A的方式CHANGE MASTER搭建主从。\n具体操作：\n\t- 利用备份方式获取Master的备份数据以及GTID范围，包含了gtid_purged='uuid:interval[-interval]'。使用innobackupex备份工具备份会将该信息保留在xtrabackup_binlog_info文件中。\n\t- 利用备份的数据搭建Slave实例，恢复备份数据。\n\t- 启动Slave实例，并且设置gtid_purged的值，跳过这段手工恢复数据的段范围。命令如下： set @@GLOBAL.GTID_PURGED='uuid:interval[-interval]'\n\t- 使用CHANGE MASTER 语句配置主从复制，如A。\n\t- 启动Slave复制后，Slave会自动跳过这段手工恢复的GTID范围，只会拉取最新的GTID信息。\n\n## 5. 实操记录\n\t* 因 Master运行时间较久，存在大量数据，BinLog不完整的情况最为复杂，而且操作过程中会包含其他几种情况，所以实际操作以此为例。\n\n\t- 备份与恢复(详见另一份Note)\n\t-\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"]],[0,0],[1971,1971]]],[1521773266569,["wangnan@wangnandeMacBook-Pro.local",[[-1,29,"\n"]],[28,28],[27,27]]],[1521773267042,["wangnan@wangnandeMacBook-Pro.local",[[-1,28,"\n"]],[27,27],[26,26]]],[1521773337554,["wangnan@wangnandeMacBook-Pro.local",[[-1,1939,"另一份Note"],[1,1946,"基于innobackupex的MySQL备份\n"]],[1939,1946],[1962,1962]]],[1521773338505,["wangnan@wangnandeMacBook-Pro.local",[[1,1939," "]],[1939,1939],[1940,1940]]],[1521773340067,["wangnan@wangnandeMacBook-Pro.local",[[-1,1962,"\n"]],[1962,1962],[1962,1962]]],[1521773792468,["wangnan@wangnandeMacBook-Pro.local",[[1,1574," "]],[1574,1574],[1575,1575]]],[1521773794110,["wangnan@wangnandeMacBook-Pro.local",[[1,1587," "]],[1587,1587],[1588,1588]]]]]]}