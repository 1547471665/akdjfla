{"compress":true,"commitItems":[["43566793-74ad-4788-82c9-0e66d242df22",1520387430852,"",[[1520387373983,["wangnan@wangnandeMacBook-Pro.local",[[1,0,"Redis数据迁移\n===\n\n\n"]],[0,0],[16,16]]],[1520390138123,["wangnan@wangnandeMacBook-Pro.local",[[-1,15,"\n"],[1,16,"思路：做"]],[15,15],[19,19]]],[1520390138425,["wangnan@wangnandeMacBook-Pro.local",[[-1,18,"做"]],[19,19],[18,18]]],[1520390164235,["wangnan@wangnandeMacBook-Pro.local",[[1,18,"做主从，待数据全部复制到从库后，关闭主服务器，设置从库为主库。"]],[18,18],[49,49]]],[1520390174821,["wangnan@wangnandeMacBook-Pro.local",[[1,18,"将新机器"]],[18,18],[22,22]]],[1520390180705,["wangnan@wangnandeMacBook-Pro.local",[[1,18,"做主从，"]],[18,18],[22,22]]],[1520390188175,["wangnan@wangnandeMacBook-Pro.local",[[1,27,"为被迁移机器的"]],[27,27],[34,34]]],[1520390188950,["wangnan@wangnandeMacBook-Pro.local",[[-1,34,"主"]],[35,35],[34,34]]],[1520390190403,["wangnan@wangnandeMacBook-Pro.local",[[1,35,"库"]],[35,35],[36,36]]],[1520390193326,["wangnan@wangnandeMacBook-Pro.local",[[1,64,"\n\n"]],[64,64],[65,65]]],[1520390193416,["wangnan@wangnandeMacBook-Pro.local",[[1,66,"\n"]],[65,65],[66,66]]],[1520390195735,["wangnan@wangnandeMacBook-Pro.local",[[-1,66,"\n"],[1,67,"## 1. "]],[66,66],[72,72]]],[1520390200002,["wangnan@wangnandeMacBook-Pro.local",[[1,72,"设置从库"]],[72,72],[76,76]]],[1520393537843,["wangnan@wangnandeMacBook-Pro.local",[[1,76,"\n\n"]],[76,76],[77,77]]],[1520393539946,["wangnan@wangnandeMacBook-Pro.local",[[-1,77,"\n"]],[77,77],[76,76]]],[1520393541173,["wangnan@wangnandeMacBook-Pro.local",[[1,77,"\n"]],[76,76],[77,77]]],[1520393542197,["wangnan@wangnandeMacBook-Pro.local",[[-1,77,"\n"],[1,78,"k"]],[77,77],[78,78]]],[1520393542612,["wangnan@wangnandeMacBook-Pro.local",[[-1,77,"k"],[1,78,"\n"]],[78,78],[77,77]]],[1520393544680,["wangnan@wangnandeMacBook-Pro.local",[[-1,77,"\n"],[1,78,"可以知己"]],[77,77],[81,81]]],[1520393545424,["wangnan@wangnandeMacBook-Pro.local",[[-1,78,"以知己"]],[81,81],[78,78]]],[1520393545761,["wangnan@wangnandeMacBook-Pro.local",[[-1,77,"可"],[1,78,"\n"]],[78,78],[77,77]]],[1520393582045,["wangnan@wangnandeMacBook-Pro.local",[[1,77,"```\nslaveof 192.168.1.1 6379\n```"]],[77,77],[109,109]]],[1520399702417,["wangnan@wangnandeMacBook-Pro.local",[[1,81,"\n"]],[80,80],[81,81]]],[1520399703464,["wangnan@wangnandeMacBook-Pro.local",[[1,81,"p"]],[81,81],[82,82]]],[1520399703869,["wangnan@wangnandeMacBook-Pro.local",[[-1,81,"p"]],[82,82],[81,81]]],[1520399708594,["wangnan@wangnandeMacBook-Pro.local",[[1,81,"从库配置文件添加："]],[81,81],[90,90]]],[1520399713790,["wangnan@wangnandeMacBook-Pro.local",[[1,116,"\n"]],[115,115],[116,116]]],[1520399714184,["wangnan@wangnandeMacBook-Pro.local",[[1,117,"\n"]],[116,116],[117,117]]],[1520399715581,["wangnan@wangnandeMacBook-Pro.local",[[1,117,"或"]],[117,117],[118,118]]],[1520399717895,["wangnan@wangnandeMacBook-Pro.local",[[1,119,"\n"]],[118,118],[119,119]]],[1520399719782,["wangnan@wangnandeMacBook-Pro.local",[[1,119,"执行"]],[119,119],[121,121]]],[1520399720787,["wangnan@wangnandeMacBook-Pro.local",[[1,122,"\n"]],[121,121],[122,122]]],[1520399733141,["wangnan@wangnandeMacBook-Pro.local",[[1,122,"salveof 192.168.1.1 6379命令"]],[122,122],[148,148]]],[1520399735117,["wangnan@wangnandeMacBook-Pro.local",[[-1,146,"命令"]],[148,148],[146,146]]],[1520399741712,["wangnan@wangnandeMacBook-Pro.local",[[1,119,"从库客户端"]],[119,119],[124,124]]],[1520399746707,["wangnan@wangnandeMacBook-Pro.local",[[1,126,"命令"]],[126,126],[128,128]]],[1520399874888,["wangnan@wangnandeMacBook-Pro.local",[[1,154,"\n"]],[153,153],[154,154]]],[1520399875035,["wangnan@wangnandeMacBook-Pro.local",[[1,155,"\n"]],[154,154],[155,155]]],[1520399881861,["wangnan@wangnandeMacBook-Pro.local",[[1,155,"如果master设置了密码"]],[155,155],[168,168]]],[1520399892382,["wangnan@wangnandeMacBook-Pro.local",[[1,163," tong"]],[163,163],[168,168]]],[1520399892922,["wangnan@wangnandeMacBook-Pro.local",[[-1,164,"tong"]],[168,168],[164,164]]],[1520399894909,["wangnan@wangnandeMacBook-Pro.local",[[1,164,"通过"]],[164,164],[166,166]]],[1520399896027,["wangnan@wangnandeMacBook-Pro.local",[[-1,163," "]],[164,164],[163,163]]],[1520399897212,["wangnan@wangnandeMacBook-Pro.local",[[1,165,"requirepass"]],[165,165],[176,176]]],[1520399921239,["wangnan@wangnandeMacBook-Pro.local",[[1,181,"："]],[181,181],[182,182]]],[1520399921542,["wangnan@wangnandeMacBook-Pro.local",[[1,183,"\n"]],[182,182],[183,183]]],[1520399923963,["wangnan@wangnandeMacBook-Pro.local",[[1,183,"配置"]],[183,183],[185,185]]],[1520399925323,["wangnan@wangnandeMacBook-Pro.local",[[1,187,"："]],[187,187],[188,188]]],[1520399926062,["wangnan@wangnandeMacBook-Pro.local",[[-1,187,"："]],[188,188],[187,187]]],[1520399927101,["wangnan@wangnandeMacBook-Pro.local",[[1,187,":"]],[187,187],[188,188]]],[1520399929596,["wangnan@wangnandeMacBook-Pro.local",[[-1,89,"："]],[90,90],[89,89]]],[1520399929925,["wangnan@wangnandeMacBook-Pro.local",[[1,89,":"]],[89,89],[90,90]]],[1520399932692,["wangnan@wangnandeMacBook-Pro.local",[[1,128,":"]],[128,128],[129,129]]],[1520399936539,["wangnan@wangnandeMacBook-Pro.local",[[-1,182,"："]],[183,183],[182,182]]],[1520399936887,["wangnan@wangnandeMacBook-Pro.local",[[1,182,":"]],[182,182],[183,183]]],[1520399937820,["wangnan@wangnandeMacBook-Pro.local",[[1,190,"\n"]],[189,189],[190,190]]],[1520399947005,["wangnan@wangnandeMacBook-Pro.local",[[1,190,"> masterauth <password>"]],[190,190],[213,213]]],[1520399951005,["wangnan@wangnandeMacBook-Pro.local",[[-1,190,"> "]],[192,192],[190,190]]],[1520399952703,["wangnan@wangnandeMacBook-Pro.local",[[1,212,"\n"]],[211,211],[212,212]]],[1520399953930,["wangnan@wangnandeMacBook-Pro.local",[[1,212,"huo"]],[212,212],[215,215]]],[1520399954504,["wangnan@wangnandeMacBook-Pro.local",[[-1,212,"huo"]],[215,215],[212,212]]],[1520399956092,["wangnan@wangnandeMacBook-Pro.local",[[1,212,"或："]],[212,212],[214,214]]],[1520399956528,["wangnan@wangnandeMacBook-Pro.local",[[-1,213,"："]],[214,214],[213,213]]],[1520399957090,["wangnan@wangnandeMacBook-Pro.local",[[1,214,"\n"]],[213,213],[214,214]]],[1520399961546,["wangnan@wangnandeMacBook-Pro.local",[[1,214,"从库命令行执行："]],[214,214],[222,222]]],[1520399962053,["wangnan@wangnandeMacBook-Pro.local",[[-1,221,"："]],[222,222],[221,221]]],[1520399962560,["wangnan@wangnandeMacBook-Pro.local",[[1,221,":"]],[221,221],[222,222]]],[1520399962806,["wangnan@wangnandeMacBook-Pro.local",[[1,223,"\n"]],[222,222],[223,223]]],[1520399970504,["wangnan@wangnandeMacBook-Pro.local",[[1,223,"config set masterauth <password>"]],[223,223],[255,255]]],[1520400478321,[null,[[-1,186,"\n`:`"],[1,190,"从库:\n"],[1,256,"``"]],[186,186],[258,258]]],[1520400478322,[null,[[1,186,"\n`:`"],[-1,186,"从库:\n"],[-1,256,"``"]],[258,258],[186,186]]],[1520400422381,["wangnan@wangnandeMacBook-Pro.local",[[-1,100,"92.168"],[1,106,"112.124"],[1,108,"12"],[1,110,"28"]],[110,110],[115,115]]],[1520400426316,["wangnan@wangnandeMacBook-Pro.local",[[1,120,"9"]],[120,120],[121,121]]],[1520400443777,["wangnan@wangnandeMacBook-Pro.local",[[-1,145,"92.168"],[1,151,"112.124"],[1,153,"12"],[1,155,"28"],[1,159,"9"]],[144,160],[166,166]]],[1520405560597,[null,[[-1,198,"\n`:`"],[1,202,"从库:\n"],[1,268,"``"]],[198,198],[270,270]]],[1520405560597,[null,[[1,198,"\n`:`"],[-1,198,"从库:\n"],[-1,268,"``"]],[270,270],[198,198]]],[1520405517473,["wangnan@wangnandeMacBook-Pro.local",[[1,272,"\n"]],[271,271],[272,272]]],[1520405522399,["wangnan@wangnandeMacBook-Pro.local",[[-1,272,"\n"],[1,273,"## 2. shuj"]],[272,272],[282,282]]],[1520405522984,["wangnan@wangnandeMacBook-Pro.local",[[-1,278,"shuj"]],[282,282],[278,278]]],[1520405524800,["wangnan@wangnandeMacBook-Pro.local",[[1,278,"数据迁移"]],[278,278],[282,282]]],[1520405525021,["wangnan@wangnandeMacBook-Pro.local",[[1,282,"\n\n"]],[282,282],[283,283]]],[1520405525866,["wangnan@wangnandeMacBook-Pro.local",[[-1,283,"\n"],[1,284,"she"]],[283,283],[286,286]]],[1520405526315,["wangnan@wangnandeMacBook-Pro.local",[[-1,284,"he"]],[286,286],[284,284]]],[1520405526428,["wangnan@wangnandeMacBook-Pro.local",[[-1,283,"s"],[1,284,"\n"]],[284,284],[283,283]]],[1520405532916,["wangnan@wangnandeMacBook-Pro.local",[[-1,283,"\n"],[1,284,"设置完成后就会进行数据秦阿姨"]],[283,283],[297,297]]],[1520405533447,["wangnan@wangnandeMacBook-Pro.local",[[-1,294,"秦阿姨"]],[297,297],[294,294]]],[1520405536050,["wangnan@wangnandeMacBook-Pro.local",[[1,294,"迁移，最好"]],[294,294],[299,299]]],[1520405537769,["wangnan@wangnandeMacBook-Pro.local",[[-1,294,"迁移，最好"]],[299,299],[294,294]]],[1520405544756,["wangnan@wangnandeMacBook-Pro.local",[[1,294,"同步，最好查看日志看是否有错误。"]],[294,294],[310,310]]],[1520405545001,["wangnan@wangnandeMacBook-Pro.local",[[1,310,"\n\n"]],[310,310],[311,311]]],[1520405545238,["wangnan@wangnandeMacBook-Pro.local",[[1,312,"\n"]],[311,311],[312,312]]],[1520405551562,["wangnan@wangnandeMacBook-Pro.local",[[-1,312,"\n"],[1,313,"## 3. 迁移完成"]],[312,312],[322,322]]],[1520405552013,["wangnan@wangnandeMacBook-Pro.local",[[1,322,"\n\nhttps://yq.aliyun.com/articles/62511"]],[322,322],[359,359]]],[1520405620583,[null,[[-1,198,"\n`:`"],[1,202,"从库:\n"],[-1,269,"\n"],[1,270,"``"],[-1,277,"s"],[-1,323,"\n"],[1,360,"\n"]],[198,198],[361,361]]],[1520405620583,[null,[[1,198,"\n`:`"],[-1,198,"从库:\n"],[1,269,"\n"],[-1,269,"``"],[1,278,"s"],[1,323,"\n"],[-1,359,"\n"]],[361,361],[198,198]]],[1520405565095,["wangnan@wangnandeMacBook-Pro.local",[[1,360,"\n"]],[359,359],[360,360]]],[1520405565218,["wangnan@wangnandeMacBook-Pro.local",[[1,361,"\n"]],[360,360],[361,361]]],[1520405567403,["wangnan@wangnandeMacBook-Pro.local",[[-1,361,"\n"],[1,362,"## 3"]],[361,361],[365,365]]],[1520405567727,["wangnan@wangnandeMacBook-Pro.local",[[-1,364,"3"]],[365,365],[364,364]]],[1520405569122,["wangnan@wangnandeMacBook-Pro.local",[[1,364,"4. shanh"]],[364,364],[372,372]]],[1520405569763,["wangnan@wangnandeMacBook-Pro.local",[[-1,367,"shanh"]],[372,372],[367,367]]],[1520405571369,["wangnan@wangnandeMacBook-Pro.local",[[1,367,"善后"]],[367,367],[369,369]]],[1520405572241,["wangnan@wangnandeMacBook-Pro.local",[[1,369,"\n\n## 善后\n\n### 确保旧的服务器的服务已经停止服务\n\n上面没有配合说明业务代码对服务器的请求切换，但是我们在切换完服务之后肯定需要转移业务代码的请求吧。那么如何确定服务已经完全转移走了呢？\n\n在旧服务器上通过`netstat`命令查看是否还有请求过来。\n\n```none\n$ netstat -an|grep \"100:6379\"|wc -l\n```\n\n有时候`netstat`的结果也不一定准，因为有些请求已经不在，但是`socket`状态还在，比如`CLOSE_WAIT`状态最长可持续2小时。同时`socket`请求太快，也会出现`netstat`没数据，但是实际网卡有流量的情况。\n\n我们可以通过`tcdump`监控网卡在该端口上确实已经没有流量。\n\n```none\ntcpdump  -i em2 -vv -nn host  192.168.1.100 and  port 6379\n```\n\n注意排除监控系统对该`redis`实例的请求。\n\n### 如何判断 redis 已经同步完毕呢?\n\n1.  在命令行查看 info `master_link_status:up`，则表示同步完成了。\n\n2.  日志文件也可以看\n\n    ```none\n    [48864] 12 Jun 11:24:03.549 * The server is now ready to accept connections on port 6310\n    [48864] 12 Jun 11:31:52.936 * SLAVE OF 192.168.50.17:8004 enabled (user request)\n    [48864] 12 Jun 11:31:53.467 * Connecting to MASTER 192.168.50.17:8004\n    [48864] 12 Jun 11:31:53.467 * MASTER <-> SLAVE sync started\n    [48864] 12 Jun 11:31:53.470 * Non blocking connect for SYNC fired the event.\n    [48864] 12 Jun 11:31:53.470 * Master replied to PING, replication can continue...\n    [48864] 12 Jun 11:31:53.470 * Partial resynchronization not possible (no cached master)\n    [48864] 12 Jun 11:31:53.470 * Master does not support PSYNC or is in error state (reply: -ERR unknown command 'PSYNC')\n    [48864] 12 Jun 11:31:53.470 * Retrying with SYNC...\n    [48864] 12 Jun 11:32:13.085 * MASTER <-> SLAVE sync: receiving 484322714 bytes from master\n    [48864] 12 Jun 11:32:18.498 * MASTER <-> SLAVE sync: Flushing old data\n    [48864] 12 Jun 11:32:18.498 * MASTER <-> SLAVE sync: Loading DB in memory\n    [48864] 12 Jun 11:32:32.349 * MASTER <-> SLAVE sync: Finished with succes\n    ```"]],[369,369],[1988,1988]]],[1520405574927,["wangnan@wangnandeMacBook-Pro.local",[[-1,376,"\n"],[-1,839," "],[1,840," "]],[376,376],[375,375]]],[1520405575952,["wangnan@wangnandeMacBook-Pro.local",[[-1,370,"## 善后"]],[375,375],[370,370]]],[1520405577662,["wangnan@wangnandeMacBook-Pro.local",[[-1,370,"\n"]],[370,370],[369,369]]],[1520405594986,["wangnan@wangnandeMacBook-Pro.local",[[1,361,"\n"]],[359,359],[360,360]]],[1520405595227,["wangnan@wangnandeMacBook-Pro.local",[[1,360,"slaveof no one"]],[360,360],[374,374]]],[1520405598318,["wangnan@wangnandeMacBook-Pro.local",[[-1,323,"https://yq.aliyun.com/articles/62511\n"]],[323,360],[323,323]]],[1520405601646,["wangnan@wangnandeMacBook-Pro.local",[[1,66,"\n"]],[65,65],[66,66]]],[1520405602369,["wangnan@wangnandeMacBook-Pro.local",[[1,65,"https://yq.aliyun.com/articles/62511\n"]],[65,65],[102,102]]],[1520405606744,["wangnan@wangnandeMacBook-Pro.local",[[1,361,"\n"]],[360,360],[361,361]]],[1520405607399,["wangnan@wangnandeMacBook-Pro.local",[[1,361,"·"]],[361,361],[362,362]]],[1520405607937,["wangnan@wangnandeMacBook-Pro.local",[[-1,361,"·"]],[362,362],[361,361]]],[1520405608692,["wangnan@wangnandeMacBook-Pro.local",[[1,361,"```"]],[361,361],[364,364]]],[1520405611617,["wangnan@wangnandeMacBook-Pro.local",[[1,380,"```"]],[380,380],[383,383]]],[1520405611986,["wangnan@wangnandeMacBook-Pro.local",[[1,384,"\n"]],[383,383],[384,384]]],[1520405614799,["wangnan@wangnandeMacBook-Pro.local",[[1,361,"\n"]],[360,360],[361,361]]],[1520405620404,["wangnan@wangnandeMacBook-Pro.local",[[1,361,"取消主从设置，从库"]],[361,361],[370,370]]],[1520405624372,[null,[[-1,236,"\n`:`"],[1,240,"从库:\n"],[-1,307,"\n"],[1,308,"``"],[-1,315,"s"],[-1,403,"\n"],[1,866,"o"],[-1,867," "],[1,2016,"\n"]],[236,236],[2017,2017]]],[1520405624372,[null,[[1,236,"\n`:`"],[-1,236,"从库:\n"],[1,307,"\n"],[-1,307,"``"],[1,316,"s"],[1,403,"\n"],[-1,865,"o"],[1,867," "],[-1,2015,"\n"]],[2017,2017],[236,236]]],[1520405623655,["wangnan@wangnandeMacBook-Pro.local",[[1,370,"升级为主库"]],[370,370],[375,375]]],[1520405645593,[null,[[-1,236,"\n`:`"],[1,240,"从库:\n"],[-1,307,"\n"],[1,308,"``"],[-1,315,"s"],[-1,408,"\n"],[1,871,"o"],[-1,872," "],[1,2021,"\n"]],[236,236],[2022,2022]]],[1520405645593,[null,[[1,236,"\n`:`"],[-1,236,"从库:\n"],[1,307,"\n"],[-1,307,"``"],[1,316,"s"],[1,408,"\n"],[-1,870,"o"],[1,872," "],[-1,2020,"\n"]],[2022,2022],[236,236]]],[1520405637705,["wangnan@wangnandeMacBook-Pro.local",[[1,2021,"\n"]],[2020,2020],[2021,2021]]],[1520405637829,["wangnan@wangnandeMacBook-Pro.local",[[1,2022,"\n"]],[2021,2021],[2022,2022]]],[1520405637952,["wangnan@wangnandeMacBook-Pro.local",[[1,2023,"\n"]],[2022,2022],[2023,2023]]],[1520405640102,["wangnan@wangnandeMacBook-Pro.local",[[-1,2023,"\n"],[1,2024,"## bei"]],[2023,2023],[2029,2029]]],[1520405640719,["wangnan@wangnandeMacBook-Pro.local",[[-1,2026,"bei"]],[2029,2029],[2026,2026]]],[1520405642697,["wangnan@wangnandeMacBook-Pro.local",[[1,2026,"备注"]],[2026,2026],[2028,2028]]],[1520405643100,["wangnan@wangnandeMacBook-Pro.local",[[1,2028,"\n\n老服务器上内存一直报警，所以要把一部分`redis`数据迁移到新服务器上去。\n\n迁移的方式有两种，一种是停服务器，搬迁数据；另一种通过主从同步转移。\n\n## 停服务器，搬迁数据\n\n1.  首先在原服务器上执行`redis-cli shutdown`命令，该命令会触发保证写`RDB`文件以及将`AOF`文件写入磁盘，不会丢失数据。 如果是`kill -9 pid`就会丢失数据。\n\n2.  然后将`RDB`文件和`AOF`文件都拷贝到新服务器上，注意需要与`redis.conf`文件中指定`RDB`文件名和`AOF`文件名匹配。\n\n3.  最后在新服务器上启动`redis`服务器。\n\n个人觉得这种方式有点暴力，因为中间将数据保存到磁盘、拷贝数据、启动服务器，将数据从磁盘导入内存，会有很长一段时间。这段时间对线上服务造成不小的影响，所以我也没这么用。\n\n## 主从同步转移\n\n1.  首先在新服务器上直接进入`redis-cli`，执行从库配置`slaveof 192.168.1.100 6379`，这里假设要将`192.168.1.100`的`6379`端口的`redis`服务转移过来。这样就已经开始同步了。通过`info`可以查看当前服务器是`slave`。\n\n2.  然后通过`info`命令查看`master_link_status`，如果为`up`，表示同步完成。（在同步过程中，执行查询的时候还是会提示\"Redis is loading the dataset in memory\"，这属于正常情况.把数据从磁盘文件加载到内存中可能会消耗很长的一段时间。）\n\n3.  最后断开主从关系，在`redis-cli`命令行下执行`slaveof no one`提示`OK`，再通过`info`查看，该新服务器已经自己变成`master`了。\n\n## 善后\n\n### 确保旧的服务器的服务已经停止服务\n\n上面没有配合说明业务代码对服务器的请求切换，但是我们在切换完服务之后肯定需要转移业务代码的请求吧。那么如何确定服务已经完全转移走了呢？\n\n在旧服务器上通过`netstat`命令查看是否还有请求过来。\n\n```none\n$ netstat -an|grep \"100:6379\"|wc -l\n```\n\n有时候`netstat`的结果也不一定准，因为有些请求已经不在，但是`socket`状态还在，比如`CLOSE_WAIT`状态最长可持续2小时。同时`socket`请求太快，也会出现`netstat`没数据，但是实际网卡有流量的情况。\n\n我们可以通过`tcdump`监控网卡在该端口上确实已经没有流量。\n\n```none\ntcpdump  -i em2 -vv -nn host  192.168.1.100 and  port 6379\n```\n\n注意排除监控系统对该`redis`实例的请求。\n\n### 如何判断 redis 已经同步完毕呢?\n\n1.  在命令行查看 info `master_link_status:up`，则表示同步完成了。\n\n2.  日志文件也可以看\n\n    ```none\n    [48864] 12 Jun 11:24:03.549 * The server is now ready to accept connections on port 6310\n    [48864] 12 Jun 11:31:52.936 * SLAVE OF 192.168.50.17:8004 enabled (user request)\n    [48864] 12 Jun 11:31:53.467 * Connecting to MASTER 192.168.50.17:8004\n    [48864] 12 Jun 11:31:53.467 * MASTER <-> SLAVE sync started\n    [48864] 12 Jun 11:31:53.470 * Non blocking connect for SYNC fired the event.\n    [48864] 12 Jun 11:31:53.470 * Master replied to PING, replication can continue...\n    [48864] 12 Jun 11:31:53.470 * Partial resynchronization not possible (no cached master)\n    [48864] 12 Jun 11:31:53.470 * Master does not support PSYNC or is in error state (reply: -ERR unknown command 'PSYNC')\n    [48864] 12 Jun 11:31:53.470 * Retrying with SYNC...\n    [48864] 12 Jun 11:32:13.085 * MASTER <-> SLAVE sync: receiving 484322714 bytes from master\n    [48864] 12 Jun 11:32:18.498 * MASTER <-> SLAVE sync: Flushing old data\n    [48864] 12 Jun 11:32:18.498 * MASTER <-> SLAVE sync: Loading DB in memory\n    [48864] 12 Jun 11:32:32.349 * MASTER <-> SLAVE sync: Finished with succes\n    ```"]],[2028,2028],[4426,4426]]],[1520405688391,[null,[[-1,236,"\n`:`"],[1,240,"从库:\n"],[-1,307,"\n"],[1,308,"``"],[-1,315,"s"],[-1,408,"\n"],[1,871,"o"],[-1,872," "],[1,2023,"\n"],[-1,2028,"\n"],[1,4427,"\n"]],[236,236],[4428,4428]]],[1520405688391,[null,[[1,236,"\n`:`"],[-1,236,"从库:\n"],[1,307,"\n"],[-1,307,"``"],[1,316,"s"],[1,408,"\n"],[-1,870,"o"],[1,872," "],[-1,2022,"\n"],[1,2028,"\n"],[-1,4426,"\n"]],[4428,4428],[236,236]]],[1520405687305,["wangnan@wangnandeMacBook-Pro.local",[[-1,928,"none"],[-1,3277," "],[1,3278," "]],[928,932],[928,928]]]]],["526271fc-0fcf-4ef6-9ca4-da81f383ccee",1527260694694,"Redis数据迁移\n===\n\n思路：做主从，将新机器做为被迁移机器的从库，待数据全部复制到从库后，关闭主服务器，设置从库为主库。\nhttps://yq.aliyun.com/articles/62511\n\n\n## 1. 设置从库\n```\n从库配置文件添加:\nslaveof 1112.124.112.128 63799\n\n或\n从库客户端执行命令:\nsalveof 1112.124.112.128 63799\n\n如果master通过requirepass设置了密码:\n配置从库:\nmasterauth <password>\n或\n从库命令行执行:\nconfig set masterauth <password>\n```\n## 2. 数据迁移\n设置完成后就会进行数据同步，最好查看日志看是否有错误。\n\n## 3. 迁移完成\n取消主从设置，从库升级为主库\n```\nslaveof no one\n```\n\n## 4. 善后\n### 确保旧的服务器的服务已经停止服务\n\n上面没有配合说明业务代码对服务器的请求切换，但是我们在切换完服务之后肯定需要转移业务代码的请求吧。那么如何确定服务已经完全转移走了呢？\n\n在旧服务器上通过`netstat`命令查看是否还有请求过来。\n\n```none\n$ netstat -an|grep \"100:6379\"|wc -l\n```\n\n有时候`netstat`的结果也不一定准，因为有些请求已经不在，但是`socket`状态还在，比如`CLOSE_WAIT`状态最长可持续2小时。同时`socket`请求太快，也会出现`netstat`没数据，但是实际网卡有流量的情况。\n\n我们可以通过`tcdump`监控网卡在该端口上确实已经没有流量。\n\n```none\ntcpdump  -i em2 -vv -nn host  192.168.1.100 and  port 6379\n```\n\n注意排除监控系统对该`redis`实例的请求。\n\n### 如何判断 redis 已经同步完毕呢?\n\n1.  在命令行查看 info `master_link_status:up`，则表示同步完成了。\n\n2.  日志文件也可以看\n\n    ```\n    [48864] 12 Jun 11:24:03.549 * The server is now ready to accept connections on port 6310\n    [48864] 12 Jun 11:31:52.936 * SLAVE OF 192.168.50.17:8004 enabled (user request)\n    [48864] 12 Jun 11:31:53.467 * Connecting to MASTER 192.168.50.17:8004\n    [48864] 12 Jun 11:31:53.467 * MASTER <-> SLAVE sync started\n    [48864] 12 Jun 11:31:53.470 * Non blocking connect for SYNC fired the event.\n    [48864] 12 Jun 11:31:53.470 * Master replied to PING, replication can continue...\n    [48864] 12 Jun 11:31:53.470 * Partial resynchronization not possible (no cached master)\n    [48864] 12 Jun 11:31:53.470 * Master does not support PSYNC or is in error state (reply: -ERR unknown command 'PSYNC')\n    [48864] 12 Jun 11:31:53.470 * Retrying with SYNC...\n    [48864] 12 Jun 11:32:13.085 * MASTER <-> SLAVE sync: receiving 484322714 bytes from master\n    [48864] 12 Jun 11:32:18.498 * MASTER <-> SLAVE sync: Flushing old data\n    [48864] 12 Jun 11:32:18.498 * MASTER <-> SLAVE sync: Loading DB in memory\n    [48864] 12 Jun 11:32:32.349 * MASTER <-> SLAVE sync: Finished with succes\n    ```\n\n\n## 备注\n老服务器上内存一直报警，所以要把一部分`redis`数据迁移到新服务器上去。\n\n迁移的方式有两种，一种是停服务器，搬迁数据；另一种通过主从同步转移。\n\n## 停服务器，搬迁数据\n\n1.  首先在原服务器上执行`redis-cli shutdown`命令，该命令会触发保证写`RDB`文件以及将`AOF`文件写入磁盘，不会丢失数据。 如果是`kill -9 pid`就会丢失数据。\n\n2.  然后将`RDB`文件和`AOF`文件都拷贝到新服务器上，注意需要与`redis.conf`文件中指定`RDB`文件名和`AOF`文件名匹配。\n\n3.  最后在新服务器上启动`redis`服务器。\n\n个人觉得这种方式有点暴力，因为中间将数据保存到磁盘、拷贝数据、启动服务器，将数据从磁盘导入内存，会有很长一段时间。这段时间对线上服务造成不小的影响，所以我也没这么用。\n\n## 主从同步转移\n\n1.  首先在新服务器上直接进入`redis-cli`，执行从库配置`slaveof 192.168.1.100 6379`，这里假设要将`192.168.1.100`的`6379`端口的`redis`服务转移过来。这样就已经开始同步了。通过`info`可以查看当前服务器是`slave`。\n\n2.  然后通过`info`命令查看`master_link_status`，如果为`up`，表示同步完成。（在同步过程中，执行查询的时候还是会提示\"Redis is loading the dataset in memory\"，这属于正常情况.把数据从磁盘文件加载到内存中可能会消耗很长的一段时间。）\n\n3.  最后断开主从关系，在`redis-cli`命令行下执行`slaveof no one`提示`OK`，再通过`info`查看，该新服务器已经自己变成`master`了。\n\n## 善后\n\n### 确保旧的服务器的服务已经停止服务\n\n上面没有配合说明业务代码对服务器的请求切换，但是我们在切换完服务之后肯定需要转移业务代码的请求吧。那么如何确定服务已经完全转移走了呢？\n\n在旧服务器上通过`netstat`命令查看是否还有请求过来。\n\n```none\n$ netstat -an|grep \"100:6379\"|wc -l\n```\n\n有时候`netstat`的结果也不一定准，因为有些请求已经不在，但是`socket`状态还在，比如`CLOSE_WAIT`状态最长可持续2小时。同时`socket`请求太快，也会出现`netstat`没数据，但是实际网卡有流量的情况。\n\n我们可以通过`tcdump`监控网卡在该端口上确实已经没有流量。\n\n```none\ntcpdump  -i em2 -vv -nn host  192.168.1.100 and  port 6379\n```\n\n注意排除监控系统对该`redis`实例的请求。\n\n### 如何判断 redis 已经同步完毕呢?\n\n1.  在命令行查看 info `master_link_status:up`，则表示同步完成了。\n\n2.  日志文件也可以看\n\n    ```none\n    [48864] 12 Jun 11:24:03.549 * The server is now ready to accept connections on port 6310\n    [48864] 12 Jun 11:31:52.936 * SLAVE OF 192.168.50.17:8004 enabled (user request)\n    [48864] 12 Jun 11:31:53.467 * Connecting to MASTER 192.168.50.17:8004\n    [48864] 12 Jun 11:31:53.467 * MASTER <-> SLAVE sync started\n    [48864] 12 Jun 11:31:53.470 * Non blocking connect for SYNC fired the event.\n    [48864] 12 Jun 11:31:53.470 * Master replied to PING, replication can continue...\n    [48864] 12 Jun 11:31:53.470 * Partial resynchronization not possible (no cached master)\n    [48864] 12 Jun 11:31:53.470 * Master does not support PSYNC or is in error state (reply: -ERR unknown command 'PSYNC')\n    [48864] 12 Jun 11:31:53.470 * Retrying with SYNC...\n    [48864] 12 Jun 11:32:13.085 * MASTER <-> SLAVE sync: receiving 484322714 bytes from master\n    [48864] 12 Jun 11:32:18.498 * MASTER <-> SLAVE sync: Flushing old data\n    [48864] 12 Jun 11:32:18.498 * MASTER <-> SLAVE sync: Loading DB in memory\n    [48864] 12 Jun 11:32:32.349 * MASTER <-> SLAVE sync: Finished with succes\n    ```\n",[[1527260643025,["wangnan@wangnandeMacBook-Pro.local",[[1,138," "]],[138,138],[139,139]]],[1527260645352,["wangnan@wangnandeMacBook-Pro.local",[[-1,137,"1 "]],[139,139],[137,137]]],[1527260648277,["wangnan@wangnandeMacBook-Pro.local",[[-1,183,"1"]],[182,182],[181,181]]],[1527260680411,["wangnan@wangnandeMacBook-Pro.local",[[1,114,"   @y(l6?Nq%dAQ<*+k"]],[114,114],[133,133]]],[1527261428352,["wangnan@wangnandeMacBook-Pro.local",[[1,179,"\n"]],[177,177],[178,178]]],[1527261428453,["wangnan@wangnandeMacBook-Pro.local",[[1,180,"\n"]],[178,178],[179,179]]],[1527261448887,["wangnan@wangnandeMacBook-Pro.local",[[1,179,"alaveof 114.215.196.126 6379"]],[179,179],[207,207]]],[1527261458535,["wangnan@wangnandeMacBook-Pro.local",[[1,253,"\n"]],[251,251],[252,252]]],[1527261458873,["wangnan@wangnandeMacBook-Pro.local",[[1,254,"\n"]],[252,252],[253,253]]],[1527261459135,["wangnan@wangnandeMacBook-Pro.local",[[1,254,"alaveof 114.215.196.126 6379\n"]],[253,253],[282,282]]],[1527261461620,["wangnan@wangnandeMacBook-Pro.local",[[-1,253,"\n"]],[252,252],[251,251]]],[1527261463676,["wangnan@wangnandeMacBook-Pro.local",[[1,283,"\n"]],[282,282],[283,283]]],[1527261473937,["wangnan@wangnandeMacBook-Pro.local",[[1,384,"\n"]],[383,383],[384,384]]],[1527261474038,["wangnan@wangnandeMacBook-Pro.local",[[1,385,"\n"]],[384,384],[385,385]]],[1527261474951,["wangnan@wangnandeMacBook-Pro.local",[[1,386,"\n"]],[384,384],[385,385]]],[1527261475188,["wangnan@wangnandeMacBook-Pro.local",[[1,385,"config set masterauth <password>"]],[385,385],[417,417]]],[1527261478337,["wangnan@wangnandeMacBook-Pro.local",[[-1,407,"<password>"],[1,417,"kele"]],[407,417],[411,411]]],[1527261533711,["wangnan@wangnandeMacBook-Pro.local",[[1,253,"s"]],[253,253],[254,254]]],[1527261548909,["wangnan@wangnandeMacBook-Pro.local",[[-1,256,"a"]],[257,257],[256,256]]],[1527261565695,["wangnan@wangnandeMacBook-Pro.local",[[-1,179,"a"],[1,180,"s"]],[179,186],[186,186]]],[1527261680554,["wangnan@wangnandeMacBook-Pro.local",[[-1,223,"a"],[1,225,"a"]],[222,229],[229,229]]],[1527261681347,["wangnan@wangnandeMacBook-Pro.local",[[-1,254,"a"],[1,256,"a"]],[253,260],[260,260]]]]]]}